<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classifica Performer - Borsa</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent: #e94560;
            --accent-hover: #ff6b81;
            --border: #2a2a4a;
            --btn-bg: #2a2a4a;
            --btn-hover: #3a3a5a;
            --header-bg: #0f0f23;
            --green: #1b7a3d;
            --green-hover: #22994d;
        }
        html.light {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1a1a2e;
            --text-secondary: #666666;
            --accent: #e94560;
            --accent-hover: #c73650;
            --border: #d0d0d0;
            --btn-bg: #e0e0e0;
            --btn-hover: #d0d0d0;
            --header-bg: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary); color: var(--text-primary);
            min-height: 100vh; display: flex; flex-direction: column;
        }
        header {
            background: var(--header-bg); border-bottom: 1px solid var(--border);
            padding: 8px 24px; display: flex; align-items: center;
            justify-content: space-between; flex-wrap: wrap; gap: 8px;
            position: sticky; top: 0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        h1 { font-size: 1.3rem; font-weight: 700; white-space: nowrap; }
        h1 span { color: var(--accent); }
        .header-controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .btn {
            background: var(--btn-bg); color: var(--text-primary); border: 1px solid var(--border);
            padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 0.82rem;
            font-weight: 500; transition: all 0.15s; white-space: nowrap; text-decoration: none;
            display: inline-flex; align-items: center;
        }
        .btn:hover { background: var(--btn-hover); border-color: var(--accent); }
        .theme-icons { display: flex; align-items: center; gap: 4px; font-size: 0.85rem; }
        .theme-toggle {
            position: relative; width: 48px; height: 26px;
            background: var(--btn-bg); border-radius: 13px; cursor: pointer;
            border: 1px solid var(--border); transition: background 0.3s;
        }
        .theme-toggle::after {
            content: ''; position: absolute; top: 3px; left: 3px;
            width: 18px; height: 18px; background: var(--accent);
            border-radius: 50%; transition: transform 0.3s;
        }
        html.light .theme-toggle::after { transform: translateX(22px); }

        /* Main layout */
        .main-content {
            flex: 1; padding: 20px 24px; max-width: 1100px; margin: 0 auto; width: 100%;
        }

        /* Filter panel */
        .filter-panel {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 10px; padding: 16px 20px; margin-bottom: 16px;
            display: flex; flex-direction: column; gap: 14px;
        }
        .filter-row { display: flex; align-items: flex-start; gap: 12px; flex-wrap: wrap; }
        .filter-label {
            font-size: 0.72rem; font-weight: 700; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.6px;
            min-width: 75px; padding-top: 6px; flex-shrink: 0;
        }
        .filter-btns { display: flex; gap: 6px; flex-wrap: wrap; }
        .cat-btn, .period-btn {
            padding: 5px 13px; border-radius: 6px; border: 1px solid var(--border);
            background: var(--btn-bg); color: var(--text-primary);
            cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.15s;
        }
        .cat-btn:hover, .period-btn:hover { border-color: var(--accent); background: var(--btn-hover); }
        .cat-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .period-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .btn-selall {
            padding: 4px 10px; border-radius: 5px; border: 1px dashed var(--border);
            background: transparent; color: var(--text-secondary);
            cursor: pointer; font-size: 0.72rem; transition: all 0.15s; white-space: nowrap;
        }
        .btn-selall:hover { border-color: var(--accent); color: var(--accent); }
        .load-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .btn-load {
            background: var(--green); color: #fff; border: 1px solid var(--green);
            padding: 8px 22px; border-radius: 7px; cursor: pointer; font-size: 0.88rem;
            font-weight: 600; transition: all 0.15s;
        }
        .btn-load:hover { background: var(--green-hover); }
        .btn-load:disabled { opacity: 0.5; cursor: not-allowed; }
        .progress-text { font-size: 0.8rem; color: var(--text-secondary); }

        /* Results header */
        .results-header {
            display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;
        }
        .sort-label { font-size: 0.78rem; color: var(--text-secondary); }
        .sort-btn {
            padding: 4px 12px; border-radius: 5px; border: 1px solid var(--border);
            background: var(--btn-bg); color: var(--text-primary);
            cursor: pointer; font-size: 0.78rem; font-weight: 500; transition: all 0.15s;
        }
        .sort-btn:hover { border-color: var(--accent); }
        .sort-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .results-info { margin-left: auto; font-size: 0.78rem; color: var(--text-secondary); }

        /* Table */
        .rank-table {
            width: 100%; border-collapse: collapse;
            border-radius: 10px; overflow: hidden; border: 1px solid var(--border);
        }
        .rank-table thead th {
            background: var(--bg-card); padding: 10px 14px;
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--text-secondary);
            border-bottom: 1px solid var(--border); text-align: left; white-space: nowrap;
        }
        .rank-table tbody td {
            padding: 9px 14px; border-bottom: 1px solid var(--border);
            font-size: 0.84rem; background: var(--bg-secondary);
        }
        .rank-table tbody tr:last-child td { border-bottom: none; }
        .rank-table tbody tr:hover td { filter: brightness(1.07); }
        html.light .rank-table tbody tr:hover td { filter: brightness(0.97); }

        .td-rank { font-weight: 700; color: var(--text-secondary); width: 36px; font-size: 0.82rem; }
        .td-rank.gold   { color: #f1c40f; }
        .td-rank.silver { color: #b0bec5; }
        .td-rank.bronze { color: #cd7f32; }
        .td-name { font-weight: 500; }
        .td-symbol { font-family: 'Courier New', monospace; font-size: 0.75rem; color: var(--text-secondary); }
        .td-change { font-weight: 700; font-size: 0.88rem; white-space: nowrap; }
        .chg-bar-wrap { height: 3px; background: var(--border); border-radius: 2px; margin-top: 5px; width: 100%; min-width: 60px; }
        .chg-bar { height: 100%; border-radius: 2px; }
        .pos { color: #2ecc71; }
        .neg { color: #e74c3c; }
        .bar-pos { background: #2ecc71; }
        .bar-neg { background: #e74c3c; }
        .td-price { font-family: monospace; font-size: 0.78rem; color: var(--text-secondary); white-space: nowrap; }
        .cat-pill {
            display: inline-block; font-size: 0.62rem; font-weight: 700;
            padding: 2px 7px; border-radius: 10px; color: #fff;
            text-transform: uppercase; letter-spacing: 0.3px; white-space: nowrap;
        }
        .pill-nasdaq      { background: #2962ff; }
        .pill-sp500       { background: #1565c0; }
        .pill-italia      { background: #1e7a2e; }
        .pill-cinesi      { background: #c62828; }
        .pill-europee     { background: #0277bd; }
        .pill-crypto      { background: #e65100; }
        .pill-commodities { background: #5d4037; }
        .pill-forex       { background: #00695c; }
        .pill-indici      { background: #37474f; }

        /* Status states */
        .status-box {
            text-align: center; padding: 52px 20px; color: var(--text-secondary); font-size: 0.9rem;
            background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px;
        }
        .status-box strong { color: var(--text-primary); }
        .spinner {
            display: inline-block; width: 28px; height: 28px; margin-bottom: 12px;
            border: 3px solid var(--border); border-top-color: var(--accent);
            border-radius: 50%; animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 700px) {
            .main-content { padding: 12px; }
            header { padding: 8px 12px; }
            h1 { font-size: 1rem; }
            .th-price, .td-price, .th-cat, .td-cat { display: none; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <h1>Classifica <span>Performer</span></h1>
        </div>
        <div class="header-controls">
            <a href="index.html" class="btn">Dashboard</a>
            <a href="calcolo.html" class="btn">Calcolatore</a>
            <div class="theme-icons">
                <span>&#9790;</span>
                <div class="theme-toggle" onclick="toggleTheme()"></div>
                <span>&#9788;</span>
            </div>
        </div>
    </header>

    <div class="main-content">
        <div class="filter-panel">
            <div class="filter-row">
                <span class="filter-label">Categorie</span>
                <div class="filter-btns" id="catBtns">
                    <button class="cat-btn active" data-cat="nasdaq">NASDAQ</button>
                    <button class="cat-btn" data-cat="sp500">S&amp;P 500</button>
                    <button class="cat-btn" data-cat="italia">Borsa Italiana</button>
                    <button class="cat-btn" data-cat="cinesi">Titoli Cinesi</button>
                    <button class="cat-btn" data-cat="europee">Europee</button>
                    <button class="cat-btn" data-cat="crypto">Crypto</button>
                    <button class="cat-btn" data-cat="commodities">Materie Prime</button>
                    <button class="cat-btn" data-cat="forex">Forex</button>
                    <button class="cat-btn" data-cat="indici">Indici</button>
                </div>
                <button class="btn-selall" id="btnSelAll" onclick="toggleSelectAll()">Tutte</button>
            </div>
            <div class="filter-row">
                <span class="filter-label">Periodo</span>
                <div class="filter-btns">
                    <button class="period-btn" data-period="2d"   data-interval="1d">1 Giorno</button>
                    <button class="period-btn" data-period="5d"   data-interval="1d">1 Settimana</button>
                    <button class="period-btn active" data-period="1mo"  data-interval="1d">1 Mese</button>
                    <button class="period-btn" data-period="3mo"  data-interval="1d">3 Mesi</button>
                    <button class="period-btn" data-period="6mo"  data-interval="1wk">6 Mesi</button>
                    <button class="period-btn" data-period="1y"   data-interval="1wk">1 Anno</button>
                    <button class="period-btn" data-period="ytd"  data-interval="1d">YTD</button>
                </div>
            </div>
            <div class="load-row">
                <button class="btn-load" id="loadBtn" onclick="loadRanking()">Carica Classifica</button>
                <span class="progress-text" id="progressText"></span>
            </div>
        </div>

        <div id="resultsHeader" class="results-header" style="display:none">
            <span class="sort-label">Ordina:</span>
            <button class="sort-btn active" id="btnDesc" onclick="sortResults('desc')">Migliori prima &#8593;</button>
            <button class="sort-btn" id="btnAsc"  onclick="sortResults('asc')">Peggiori prima &#8595;</button>
            <span class="results-info" id="resultsInfo"></span>
        </div>

        <div id="resultsArea">
            <div class="status-box">
                Seleziona le categorie e il periodo, poi clicca <strong>Carica Classifica</strong>
            </div>
        </div>
    </div>

    <script>
    // ==================== ASSET DEFINITIONS ====================
    const ASSETS = {
        nasdaq: {
            label: 'NASDAQ', pillClass: 'pill-nasdaq',
            items: [
                {symbol:'AAPL',  name:'Apple'},
                {symbol:'MSFT',  name:'Microsoft'},
                {symbol:'NVDA',  name:'NVIDIA'},
                {symbol:'AMZN',  name:'Amazon'},
                {symbol:'META',  name:'Meta'},
                {symbol:'GOOGL', name:'Alphabet'},
                {symbol:'TSLA',  name:'Tesla'},
                {symbol:'AVGO',  name:'Broadcom'},
                {symbol:'NFLX',  name:'Netflix'},
                {symbol:'AMD',   name:'AMD'},
                {symbol:'ADBE',  name:'Adobe'},
                {symbol:'QCOM',  name:'Qualcomm'},
                {symbol:'COST',  name:'Costco'},
                {symbol:'INTC',  name:'Intel'},
                {symbol:'CSCO',  name:'Cisco'},
                {symbol:'PYPL',  name:'PayPal'},
                {symbol:'SBUX',  name:'Starbucks'},
                {symbol:'ORCL',  name:'Oracle'},
                {symbol:'INTU',  name:'Intuit'},
                {symbol:'AMAT',  name:'Applied Materials'}
            ]
        },
        sp500: {
            label: 'S&P 500', pillClass: 'pill-sp500',
            items: [
                {symbol:'JPM',   name:'JPMorgan Chase'},
                {symbol:'V',     name:'Visa'},
                {symbol:'WMT',   name:'Walmart'},
                {symbol:'MA',    name:'Mastercard'},
                {symbol:'XOM',   name:'ExxonMobil'},
                {symbol:'JNJ',   name:'Johnson & Johnson'},
                {symbol:'PG',    name:'Procter & Gamble'},
                {symbol:'UNH',   name:'UnitedHealth'},
                {symbol:'HD',    name:'Home Depot'},
                {symbol:'CVX',   name:'Chevron'},
                {symbol:'MRK',   name:'Merck'},
                {symbol:'BAC',   name:'Bank of America'},
                {symbol:'KO',    name:'Coca-Cola'},
                {symbol:'LLY',   name:'Eli Lilly'},
                {symbol:'ABBV',  name:'AbbVie'},
                {symbol:'PFE',   name:'Pfizer'},
                {symbol:'DIS',   name:'Walt Disney'},
                {symbol:'MCD',   name:"McDonald's"},
                {symbol:'WFC',   name:'Wells Fargo'},
                {symbol:'GS',    name:'Goldman Sachs'}
            ]
        },
        italia: {
            label: 'Borsa IT', pillClass: 'pill-italia',
            items: [
                {symbol:'ENI.MI',   name:'Eni'},
                {symbol:'ENEL.MI',  name:'Enel'},
                {symbol:'ISP.MI',   name:'Intesa Sanpaolo'},
                {symbol:'UCG.MI',   name:'UniCredit'},
                {symbol:'STM.MI',   name:'STMicroelectronics'},
                {symbol:'G.MI',     name:'Generali'},
                {symbol:'STLAM.MI', name:'Stellantis'},
                {symbol:'TIT.MI',   name:'Telecom Italia'},
                {symbol:'MB.MI',    name:'Mediobanca'},
                {symbol:'FBK.MI',   name:'FinecoBank'},
                {symbol:'LDO.MI',   name:'Leonardo'},
                {symbol:'MONC.MI',  name:'Moncler'},
                {symbol:'RACE.MI',  name:'Ferrari'},
                {symbol:'BMED.MI',  name:'Banca Mediolanum'},
                {symbol:'CNHI.MI',  name:'CNH Industrial'},
                {symbol:'HER.MI',   name:'Hera'},
                {symbol:'INW.MI',   name:'Inwit'},
                {symbol:'AMP.MI',   name:'Amplifon'},
                {symbol:'PRY.MI',   name:'Prysmian'},
                {symbol:'CPR.MI',   name:'Azimut'}
            ]
        },
        cinesi: {
            label: 'Cinesi', pillClass: 'pill-cinesi',
            items: [
                {symbol:'BABA',  name:'Alibaba'},
                {symbol:'JD',    name:'JD.com'},
                {symbol:'BIDU',  name:'Baidu'},
                {symbol:'PDD',   name:'PDD (Temu)'},
                {symbol:'NIO',   name:'NIO'},
                {symbol:'XPEV',  name:'XPeng'},
                {symbol:'LI',    name:'Li Auto'},
                {symbol:'TME',   name:'Tencent Music'},
                {symbol:'NTES',  name:'NetEase'},
                {symbol:'YUMC',  name:'Yum China'},
                {symbol:'EDU',   name:'New Oriental'},
                {symbol:'FUTU',  name:'Futu Holdings'},
                {symbol:'IQ',    name:'iQIYI'},
                {symbol:'MNSO',  name:'MINISO'},
                {symbol:'ZH',    name:'Zhihu'}
            ]
        },
        europee: {
            label: 'Europee', pillClass: 'pill-europee',
            items: [
                {symbol:'ASML.AS',  name:'ASML'},
                {symbol:'SAP.DE',   name:'SAP'},
                {symbol:'NESN.SW',  name:'Nestlé'},
                {symbol:'MC.PA',    name:'LVMH'},
                {symbol:'OR.PA',    name:"L'Oréal"},
                {symbol:'SIE.DE',   name:'Siemens'},
                {symbol:'TTE.PA',   name:'TotalEnergies'},
                {symbol:'NOVN.SW',  name:'Novartis'},
                {symbol:'ALV.DE',   name:'Allianz'},
                {symbol:'BNP.PA',   name:'BNP Paribas'},
                {symbol:'AZN.L',    name:'AstraZeneca'},
                {symbol:'AIR.PA',   name:'Airbus'},
                {symbol:'VOW3.DE',  name:'Volkswagen'},
                {symbol:'BMW.DE',   name:'BMW'},
                {symbol:'ROG.SW',   name:'Roche'}
            ]
        },
        crypto: {
            label: 'Crypto', pillClass: 'pill-crypto',
            items: [
                {symbol:'BTC-USD',   name:'Bitcoin'},
                {symbol:'ETH-USD',   name:'Ethereum'},
                {symbol:'BNB-USD',   name:'BNB'},
                {symbol:'SOL-USD',   name:'Solana'},
                {symbol:'XRP-USD',   name:'XRP'},
                {symbol:'ADA-USD',   name:'Cardano'},
                {symbol:'DOGE-USD',  name:'Dogecoin'},
                {symbol:'AVAX-USD',  name:'Avalanche'},
                {symbol:'DOT-USD',   name:'Polkadot'},
                {symbol:'LINK-USD',  name:'Chainlink'},
                {symbol:'LTC-USD',   name:'Litecoin'},
                {symbol:'BCH-USD',   name:'Bitcoin Cash'},
                {symbol:'ATOM-USD',  name:'Cosmos'},
                {symbol:'UNI-USD',   name:'Uniswap'},
                {symbol:'MATIC-USD', name:'Polygon'}
            ]
        },
        commodities: {
            label: 'Materie Prime', pillClass: 'pill-commodities',
            items: [
                {symbol:'GC=F',  name:'Oro'},
                {symbol:'SI=F',  name:'Argento'},
                {symbol:'CL=F',  name:'Petrolio WTI'},
                {symbol:'BZ=F',  name:'Petrolio Brent'},
                {symbol:'NG=F',  name:'Gas Naturale'},
                {symbol:'HG=F',  name:'Rame'},
                {symbol:'ZW=F',  name:'Grano'},
                {symbol:'ZC=F',  name:'Mais'},
                {symbol:'PL=F',  name:'Platino'},
                {symbol:'PA=F',  name:'Palladio'}
            ]
        },
        forex: {
            label: 'Forex', pillClass: 'pill-forex',
            items: [
                {symbol:'EURUSD=X', name:'EUR/USD'},
                {symbol:'GBPUSD=X', name:'GBP/USD'},
                {symbol:'USDJPY=X', name:'USD/JPY'},
                {symbol:'USDCHF=X', name:'USD/CHF'},
                {symbol:'AUDUSD=X', name:'AUD/USD'},
                {symbol:'USDCAD=X', name:'USD/CAD'},
                {symbol:'EURGBP=X', name:'EUR/GBP'},
                {symbol:'EURJPY=X', name:'EUR/JPY'},
                {symbol:'NZDUSD=X', name:'NZD/USD'},
                {symbol:'GBPJPY=X', name:'GBP/JPY'}
            ]
        },
        indici: {
            label: 'Indici', pillClass: 'pill-indici',
            items: [
                {symbol:'^GSPC',    name:'S&P 500'},
                {symbol:'^IXIC',    name:'NASDAQ Composite'},
                {symbol:'^DJI',     name:'Dow Jones'},
                {symbol:'^FTSE',    name:'FTSE 100'},
                {symbol:'^GDAXI',   name:'DAX 40'},
                {symbol:'^FCHI',    name:'CAC 40'},
                {symbol:'^N225',    name:'Nikkei 225'},
                {symbol:'^HSI',     name:'Hang Seng'},
                {symbol:'^STOXX50E',name:'Euro Stoxx 50'},
                {symbol:'^RUT',     name:'Russell 2000'},
                {symbol:'000001.SS',name:'Shanghai Composite'},
                {symbol:'^BSESN',   name:'BSE Sensex'}
            ]
        }
    };

    // ==================== STATE ====================
    let isDark = true;
    let rankingData = [];
    let currentSort = 'desc';

    // ==================== THEME ====================
    function toggleTheme() {
        isDark = !isDark;
        document.documentElement.classList.toggle('light', !isDark);
        try {
            const d = localStorage.getItem('dashboardBorsa');
            if (d) { const p = JSON.parse(d); p.dark = isDark; localStorage.setItem('dashboardBorsa', JSON.stringify(p)); }
        } catch(e) {}
    }
    function loadTheme() {
        try {
            const d = localStorage.getItem('dashboardBorsa');
            if (d) { const p = JSON.parse(d); if (p.dark !== undefined) isDark = p.dark; }
        } catch(e) {}
        document.documentElement.classList.toggle('light', !isDark);
    }

    // ==================== FILTERS ====================
    document.querySelectorAll('.cat-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.classList.toggle('active');
            updateSelAllBtn();
        });
    });
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });
    });

    function updateSelAllBtn() {
        const all = document.querySelectorAll('.cat-btn');
        const active = document.querySelectorAll('.cat-btn.active');
        document.getElementById('btnSelAll').textContent = active.length === all.length ? 'Rimuovi tutte' : 'Tutte';
    }

    function toggleSelectAll() {
        const all = document.querySelectorAll('.cat-btn');
        const active = document.querySelectorAll('.cat-btn.active');
        const selectAll = active.length !== all.length;
        all.forEach(btn => btn.classList.toggle('active', selectAll));
        updateSelAllBtn();
    }

    // ==================== API ====================
    function escapeHtml(s) {
        return String(s || '')
            .replace(/&/g, '&amp;').replace(/</g, '&lt;')
            .replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    async function fetchWithTimeout(url, options, ms) {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), ms || 5000);
        try {
            return await fetch(url, { ...options, signal: ctrl.signal });
        } finally { clearTimeout(t); }
    }

    async function fetchJson(url, ms) {
        const proxies = [
            url,
            'https://corsproxy.io/?' + encodeURIComponent(url),
            'https://api.allorigins.win/raw?url=' + encodeURIComponent(url)
        ];
        const attempts = proxies.map(async u => {
            const res = await fetchWithTimeout(u, { headers: { Accept: 'application/json' } }, ms || 5000);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const txt = await res.text();
            return JSON.parse(txt.replace(/^\uFEFF/, '').replace(/^\)\]\}',?\s*/, '').trim());
        });
        return Promise.any(attempts);
    }

    async function fetchPerf(symbol, range, interval) {
        const url = 'https://query2.finance.yahoo.com/v8/finance/chart/' +
            encodeURIComponent(symbol) + '?interval=' + interval + '&range=' + range;
        try {
            const data = await fetchJson(url, 7000);
            const res = data && data.chart && data.chart.result && data.chart.result[0];
            if (!res) return null;
            const meta = res.meta || {};
            const rawCloses = (res.indicators && res.indicators.quote && res.indicators.quote[0] && res.indicators.quote[0].close) || [];
            const closes = rawCloses.filter(c => c != null && isFinite(c) && c > 0);

            // For 1-day period: use meta's change % for accuracy (handles open markets)
            if (range === '2d' && meta.regularMarketChangePercent != null) {
                return {
                    changePct: meta.regularMarketChangePercent,
                    currentPrice: meta.regularMarketPrice || null,
                    currency: meta.currency || ''
                };
            }

            // For all other periods: first close vs current market price
            const curPrice = (meta.regularMarketPrice && isFinite(meta.regularMarketPrice) && meta.regularMarketPrice > 0)
                ? meta.regularMarketPrice : null;

            if (closes.length < 1) return null;
            const startPrice = closes[0];
            const endPrice = curPrice || closes[closes.length - 1];
            if (!startPrice || !endPrice || startPrice <= 0) return null;

            return {
                changePct: ((endPrice - startPrice) / startPrice) * 100,
                currentPrice: endPrice,
                currency: meta.currency || ''
            };
        } catch(e) { return null; }
    }

    // ==================== LOAD ====================
    async function loadRanking() {
        const selectedCats = [...document.querySelectorAll('.cat-btn.active')].map(b => b.dataset.cat);
        const periodBtn = document.querySelector('.period-btn.active');
        if (!selectedCats.length) { alert('Seleziona almeno una categoria'); return; }

        const range = periodBtn.dataset.period;
        const interval = periodBtn.dataset.interval;

        // Build asset list
        const toFetch = [];
        selectedCats.forEach(cat => {
            ASSETS[cat].items.forEach(item => {
                toFetch.push({
                    symbol: item.symbol, name: item.name,
                    cat, catLabel: ASSETS[cat].label, pillClass: ASSETS[cat].pillClass
                });
            });
        });

        const total = toFetch.length;
        let done = 0;

        const loadBtn = document.getElementById('loadBtn');
        loadBtn.disabled = true;
        loadBtn.textContent = 'Caricamento...';
        document.getElementById('resultsHeader').style.display = 'none';
        document.getElementById('progressText').textContent = '0 / ' + total;
        document.getElementById('resultsArea').innerHTML =
            '<div class="status-box"><div class="spinner"></div><div>Recupero dati per ' + total + ' asset in corso...</div></div>';

        const promises = toFetch.map(async asset => {
            const perf = await fetchPerf(asset.symbol, range, interval);
            done++;
            document.getElementById('progressText').textContent = done + ' / ' + total;
            if (!perf) return null;
            return Object.assign({}, asset, perf);
        });

        const results = (await Promise.all(promises)).filter(Boolean);

        loadBtn.disabled = false;
        loadBtn.textContent = 'Aggiorna';

        if (!results.length) {
            document.getElementById('resultsArea').innerHTML =
                '<div class="status-box">Nessun dato disponibile. Controlla la connessione e riprova.</div>';
            document.getElementById('progressText').textContent = '';
            return;
        }

        document.getElementById('progressText').textContent =
            results.length + ' / ' + total + ' asset caricati';

        rankingData = results;
        currentSort = 'desc';
        document.getElementById('resultsHeader').style.display = 'flex';
        document.getElementById('btnDesc').classList.add('active');
        document.getElementById('btnAsc').classList.remove('active');
        renderRanking();
    }

    function sortResults(dir) {
        currentSort = dir;
        document.getElementById('btnDesc').classList.toggle('active', dir === 'desc');
        document.getElementById('btnAsc').classList.toggle('active', dir === 'asc');
        renderRanking();
    }

    // ==================== RENDER ====================
    function formatPrice(price, currency) {
        if (price == null || !isFinite(price)) return '—';
        const abs = Math.abs(price);
        const dec = abs < 0.0001 ? 6 : abs < 0.01 ? 5 : abs < 1 ? 4 : 2;
        const s = price.toLocaleString('it-IT', { minimumFractionDigits: dec, maximumFractionDigits: dec });
        return currency ? s + ' ' + currency : s;
    }

    function renderRanking() {
        const sorted = [...rankingData].sort((a, b) =>
            currentSort === 'desc' ? b.changePct - a.changePct : a.changePct - b.changePct
        );
        const maxAbs = Math.max(...sorted.map(r => Math.abs(r.changePct)), 0.001);

        document.getElementById('resultsInfo').textContent = sorted.length + ' asset';

        const rows = sorted.map((item, idx) => {
            const rank = idx + 1;
            const isPos = item.changePct >= 0;
            const pct = (isPos ? '+' : '') + item.changePct.toFixed(2) + '%';
            const barW = Math.min(100, Math.round((Math.abs(item.changePct) / maxAbs) * 100));
            const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';

            return '<tr>' +
                '<td class="td-rank ' + rankClass + '">' + rank + '</td>' +
                '<td class="td-name">' + escapeHtml(item.name) + '</td>' +
                '<td class="td-symbol">' + escapeHtml(item.symbol) + '</td>' +
                '<td class="td-change ' + (isPos ? 'pos' : 'neg') + '">' +
                    pct +
                    '<div class="chg-bar-wrap"><div class="chg-bar ' + (isPos ? 'bar-pos' : 'bar-neg') + '" style="width:' + barW + '%"></div></div>' +
                '</td>' +
                '<td class="td-price td-cat-hide-price">' + formatPrice(item.currentPrice, item.currency) + '</td>' +
                '<td class="td-cat-hide-cat"><span class="cat-pill ' + item.pillClass + '">' + escapeHtml(item.catLabel) + '</span></td>' +
                '</tr>';
        }).join('');

        document.getElementById('resultsArea').innerHTML =
            '<table class="rank-table">' +
            '<thead><tr>' +
            '<th>#</th><th>Nome</th><th>Simbolo</th><th>Variazione</th>' +
            '<th class="th-price">Prezzo Attuale</th>' +
            '<th class="th-cat">Categoria</th>' +
            '</tr></thead>' +
            '<tbody>' + rows + '</tbody>' +
            '</table>';
    }

    // ==================== INIT ====================
    loadTheme();
    </script>
</body>
</html>
