<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classifica Performer - Borsa</title>
    <style>
        :root {
            --bg-primary: #1a1a2e; --bg-secondary: #16213e; --bg-card: #0f3460;
            --text-primary: #e0e0e0; --text-secondary: #a0a0a0;
            --accent: #e94560; --accent-hover: #ff6b81;
            --border: #2a2a4a; --btn-bg: #2a2a4a; --btn-hover: #3a3a5a;
            --header-bg: #0f0f23; --green: #1b7a3d; --green-hover: #22994d;
        }
        html.light {
            --bg-primary: #f0f2f5; --bg-secondary: #ffffff; --bg-card: #ffffff;
            --text-primary: #1a1a2e; --text-secondary: #666666;
            --accent: #e94560; --accent-hover: #c73650;
            --border: #d0d0d0; --btn-bg: #e0e0e0; --btn-hover: #d0d0d0; --header-bg: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary); color: var(--text-primary);
            min-height: 100vh; display: flex; flex-direction: column;
        }
        header {
            background: var(--header-bg); border-bottom: 1px solid var(--border);
            padding: 8px 24px; display: flex; align-items: center;
            justify-content: space-between; flex-wrap: wrap; gap: 8px;
            position: sticky; top: 0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        h1 { font-size: 1.3rem; font-weight: 700; white-space: nowrap; }
        h1 span { color: var(--accent); }
        .header-controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .btn {
            background: var(--btn-bg); color: var(--text-primary); border: 1px solid var(--border);
            padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 0.82rem;
            font-weight: 500; transition: all 0.15s; white-space: nowrap;
            text-decoration: none; display: inline-flex; align-items: center;
        }
        .btn:hover { background: var(--btn-hover); border-color: var(--accent); }
        .theme-icons { display: flex; align-items: center; gap: 4px; font-size: 0.85rem; }
        .theme-toggle {
            position: relative; width: 48px; height: 26px;
            background: var(--btn-bg); border-radius: 13px; cursor: pointer;
            border: 1px solid var(--border);
        }
        .theme-toggle::after {
            content: ''; position: absolute; top: 3px; left: 3px;
            width: 18px; height: 18px; background: var(--accent);
            border-radius: 50%; transition: transform 0.3s;
        }
        html.light .theme-toggle::after { transform: translateX(22px); }

        /* Main */
        .main-content { flex: 1; padding: 20px 24px; max-width: 1100px; margin: 0 auto; width: 100%; }

        /* Filter panel */
        .filter-panel {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 10px; padding: 16px 20px; margin-bottom: 16px;
            display: flex; flex-direction: column; gap: 14px;
        }
        .filter-row { display: flex; align-items: flex-start; gap: 12px; flex-wrap: wrap; }
        .filter-label {
            font-size: 0.72rem; font-weight: 700; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.6px;
            min-width: 90px; padding-top: 6px; flex-shrink: 0;
        }
        .filter-btns { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }

        /* Cat / period / limit buttons */
        .cat-btn, .period-btn, .limit-btn {
            padding: 5px 13px; border-radius: 6px; border: 1px solid var(--border);
            background: var(--btn-bg); color: var(--text-primary);
            cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.15s;
            white-space: nowrap;
        }
        .cat-btn:hover, .period-btn:hover, .limit-btn:hover { border-color: var(--accent); background: var(--btn-hover); }
        .cat-btn.active, .period-btn.active, .limit-btn.active {
            background: var(--accent); color: #fff; border-color: var(--accent);
        }

        /* Custom category wrapper (hover dropdown for edit/delete) */
        .custom-cat-wrapper { position: relative; display: inline-flex; }
        .custom-cat-actions {
            display: none; position: absolute; top: calc(100% + 4px); left: 0; z-index: 60;
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 6px; padding: 4px; min-width: 150px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.35);
            flex-direction: column; gap: 2px;
        }
        .custom-cat-wrapper:hover .custom-cat-actions,
        .custom-cat-actions:hover { display: flex; }
        .custom-cat-actions button {
            background: none; border: none; color: var(--text-primary);
            padding: 6px 10px; text-align: left; cursor: pointer;
            font-size: 0.78rem; border-radius: 4px; white-space: nowrap;
        }
        .custom-cat-actions button:hover { background: var(--btn-hover); }
        .custom-cat-actions button.danger { color: var(--accent); }
        .custom-cat-actions button.danger:hover { background: rgba(233,69,96,0.15); }

        /* Utility buttons */
        .btn-selall, .btn-new-cat {
            padding: 4px 10px; border-radius: 5px; border: 1px dashed var(--border);
            background: transparent; color: var(--text-secondary);
            cursor: pointer; font-size: 0.72rem; transition: all 0.15s; white-space: nowrap;
        }
        .btn-selall:hover { border-color: var(--accent); color: var(--accent); }
        .btn-new-cat {
            border-color: var(--accent); color: var(--accent); font-size: 0.78rem; padding: 4px 12px;
        }
        .btn-new-cat:hover { background: var(--accent); color: #fff; }

        /* Limit custom input */
        .limit-input {
            width: 62px; padding: 5px 8px; border-radius: 6px;
            border: 1px solid var(--border); background: var(--btn-bg);
            color: var(--text-primary); font-size: 0.8rem; font-family: inherit;
            text-align: center; transition: border-color 0.15s;
        }
        .limit-input:focus { outline: none; border-color: var(--accent); }
        .limit-input.active { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(233,69,96,0.25); }
        /* hide number arrows */
        .limit-input::-webkit-outer-spin-button,
        .limit-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .limit-input[type=number] { -moz-appearance: textfield; }

        /* Load row */
        .load-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .btn-load {
            background: var(--green); color: #fff; border: 1px solid var(--green);
            padding: 8px 22px; border-radius: 7px; cursor: pointer; font-size: 0.88rem;
            font-weight: 600; transition: all 0.15s;
        }
        .btn-load:hover { background: var(--green-hover); }
        .btn-load:disabled { opacity: 0.5; cursor: not-allowed; }
        .progress-text { font-size: 0.8rem; color: var(--text-secondary); }

        /* Results header */
        .results-header {
            display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;
        }
        .sort-label { font-size: 0.78rem; color: var(--text-secondary); }
        .sort-btn {
            padding: 4px 12px; border-radius: 5px; border: 1px solid var(--border);
            background: var(--btn-bg); color: var(--text-primary);
            cursor: pointer; font-size: 0.78rem; font-weight: 500; transition: all 0.15s;
        }
        .sort-btn:hover { border-color: var(--accent); }
        .sort-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .results-info { margin-left: auto; font-size: 0.78rem; color: var(--text-secondary); }

        /* Table */
        .rank-table { width: 100%; border-collapse: collapse; border-radius: 10px; overflow: hidden; border: 1px solid var(--border); }
        .rank-table thead th {
            background: var(--bg-card); padding: 10px 14px;
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--text-secondary);
            border-bottom: 1px solid var(--border); text-align: left; white-space: nowrap;
        }
        .rank-table tbody td {
            padding: 9px 14px; border-bottom: 1px solid var(--border);
            font-size: 0.84rem; background: var(--bg-secondary);
        }
        .rank-table tbody tr:last-child td { border-bottom: none; }
        .rank-table tbody tr:hover td { filter: brightness(1.07); }
        html.light .rank-table tbody tr:hover td { filter: brightness(0.97); }

        .td-rank { font-weight: 700; color: var(--text-secondary); width: 36px; font-size: 0.82rem; }
        .td-rank.gold   { color: #f1c40f; }
        .td-rank.silver { color: #b0bec5; }
        .td-rank.bronze { color: #cd7f32; }
        .td-name { font-weight: 500; }
        .td-symbol { font-family: 'Courier New', monospace; font-size: 0.75rem; color: var(--text-secondary); }
        .chart-links { display: flex; align-items: center; gap: 7px; }
        .asset-link { color: inherit; text-decoration: none; display: flex; align-items: center; gap: 5px; flex: 1; min-width: 0; }
        .asset-link:hover { color: var(--accent); }
        .asset-link:hover .link-arrow { opacity: 1; transform: translate(1px,-1px); }
        .link-arrow {
            opacity: 0; font-size: 0.7rem; color: var(--accent);
            transition: opacity 0.15s, transform 0.15s; flex-shrink: 0;
        }
        .tv-link {
            font-size: 0.62rem; font-weight: 700; color: var(--text-secondary);
            text-decoration: none; padding: 1px 5px; border-radius: 3px;
            border: 1px solid var(--border); background: var(--btn-bg);
            transition: all 0.15s; flex-shrink: 0; opacity: 0.65; white-space: nowrap;
            letter-spacing: 0.3px;
        }
        .tv-link:hover { border-color: #2962ff; color: #2962ff; opacity: 1; background: rgba(41,98,255,0.12); }
        .td-change { font-weight: 700; font-size: 0.88rem; white-space: nowrap; }
        .chg-bar-wrap { height: 3px; background: var(--border); border-radius: 2px; margin-top: 5px; width: 100%; min-width: 60px; }
        .chg-bar { height: 100%; border-radius: 2px; }
        .pos { color: #2ecc71; } .neg { color: #e74c3c; }
        .bar-pos { background: #2ecc71; } .bar-neg { background: #e74c3c; }
        .td-price { font-family: monospace; font-size: 0.78rem; color: var(--text-secondary); white-space: nowrap; }
        .cat-pill {
            display: inline-block; font-size: 0.62rem; font-weight: 700;
            padding: 2px 7px; border-radius: 10px; color: #fff;
            text-transform: uppercase; letter-spacing: 0.3px; white-space: nowrap;
        }
        .pill-nasdaq      { background: #2962ff; } .pill-sp500       { background: #1565c0; }
        .pill-italia      { background: #1e7a2e; } .pill-cinesi      { background: #c62828; }
        .pill-europee     { background: #0277bd; } .pill-crypto      { background: #e65100; }
        .pill-commodities { background: #5d4037; } .pill-forex       { background: #00695c; }
        .pill-indici      { background: #37474f; }

        /* Status */
        .status-box {
            text-align: center; padding: 52px 20px; color: var(--text-secondary); font-size: 0.9rem;
            background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px;
        }
        .status-box strong { color: var(--text-primary); }
        .spinner {
            display: inline-block; width: 28px; height: 28px; margin-bottom: 12px;
            border: 3px solid var(--border); border-top-color: var(--accent);
            border-radius: 50%; animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ======= MODAL ======= */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.65); z-index: 200;
            align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 12px; padding: 24px; width: min(500px, 94vw);
            max-height: 90vh; overflow-y: auto;
        }
        .modal h2 { font-size: 1.05rem; font-weight: 700; margin-bottom: 18px; }
        .modal-field { margin-bottom: 14px; display: flex; flex-direction: column; gap: 5px; }
        .modal-field label {
            font-size: 0.72rem; font-weight: 700; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .modal-field input, .modal-field textarea {
            background: var(--btn-bg); color: var(--text-primary);
            border: 1px solid var(--border); border-radius: 6px;
            padding: 8px 10px; font-size: 0.88rem; font-family: inherit;
            transition: border-color 0.15s; resize: vertical;
        }
        .modal-field input:focus, .modal-field textarea:focus {
            outline: none; border-color: var(--accent);
        }
        .modal-hint {
            font-size: 0.75rem; color: var(--text-secondary);
            background: var(--bg-card); border-radius: 6px;
            padding: 8px 10px; margin-bottom: 16px; line-height: 1.5;
        }
        .modal-hint code { font-family: monospace; color: var(--accent); }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }
        .modal-actions .btn-cancel {
            background: var(--btn-bg); color: var(--text-primary); border: 1px solid var(--border);
            padding: 7px 16px; border-radius: 6px; cursor: pointer; font-size: 0.84rem; font-weight: 500;
        }
        .modal-actions .btn-cancel:hover { border-color: var(--accent); }
        .modal-actions .btn-save {
            background: var(--accent); color: #fff; border: 1px solid var(--accent);
            padding: 7px 20px; border-radius: 6px; cursor: pointer; font-size: 0.84rem; font-weight: 600;
        }
        .modal-actions .btn-save:hover { background: var(--accent-hover); }

        /* ---- ASSET SEARCH / AUTOCOMPLETE ---- */
        .asset-search-wrap { position: relative; }
        .asset-search-input {
            width: 100%; background: var(--btn-bg); color: var(--text-primary);
            border: 1px solid var(--border); border-radius: 6px;
            padding: 9px 12px; font-size: 0.88rem; font-family: inherit;
            transition: border-color 0.15s;
        }
        .asset-search-input:focus { outline: none; border-color: var(--accent); }
        .asset-dropdown {
            display: none; position: absolute; top: calc(100% + 3px); left: 0; right: 0;
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 7px; z-index: 310; max-height: 230px; overflow-y: auto;
            box-shadow: 0 6px 28px rgba(0,0,0,0.45);
        }
        .asset-dropdown.open { display: block; }
        .asset-dropdown-item {
            padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px;
            border-bottom: 1px solid var(--border); font-size: 0.83rem; transition: background 0.1s;
        }
        .asset-dropdown-item:last-child { border-bottom: none; }
        .asset-dropdown-item:hover { background: var(--btn-hover); }
        .asset-dropdown-item.custom-add { color: var(--accent); font-size: 0.8rem; }
        .adi-symbol { font-family: monospace; font-size: 0.75rem; color: var(--accent); min-width: 74px; flex-shrink: 0; }
        .adi-name   { flex: 1; }
        .adi-cat    { font-size: 0.62rem; color: var(--text-secondary); flex-shrink: 0; }
        .asset-tags {
            display: flex; flex-wrap: wrap; gap: 5px; align-items: flex-start;
            min-height: 38px; margin: 8px 0 4px;
            padding: 6px 8px; background: var(--bg-card);
            border: 1px solid var(--border); border-radius: 6px;
        }
        .asset-tag {
            display: inline-flex; align-items: center; gap: 4px;
            background: var(--btn-bg); border: 1px solid var(--border);
            padding: 2px 6px 2px 8px; border-radius: 4px; font-size: 0.76rem;
        }
        .asset-tag-sym  { font-family: monospace; color: var(--accent); font-size: 0.7rem; }
        .asset-tag-name { color: var(--text-primary); }
        .asset-tag-remove {
            color: var(--text-secondary); cursor: pointer; font-size: 0.82rem;
            transition: color 0.15s; line-height: 1; padding: 0 1px; margin-left: 1px;
        }
        .asset-tag-remove:hover { color: var(--accent); }
        .tags-empty { font-size: 0.74rem; color: var(--text-secondary); font-style: italic; align-self: center; }

        /* Responsive */
        @media (max-width: 700px) {
            .main-content { padding: 12px; }
            header { padding: 8px 12px; }
            h1 { font-size: 1rem; }
            .th-price, .td-price, .th-cat, .td-cat { display: none; }
            .filter-label { min-width: 70px; }
        }
    </style>
</head>
<body>
<header>
    <div class="header-left">
        <h1>Classifica <span>Performer</span></h1>
    </div>
    <div class="header-controls">
        <a href="index.html" class="btn">Dashboard</a>
        <a href="calcolo.html" class="btn">Calcolatore</a>
        <a href="analisi.html" class="btn">Analisi</a>
        <button class="btn" onclick="exportShareLink()" title="Copia link per sincronizzare le impostazioni su un altro dispositivo">Condividi</button>
        <div class="theme-icons">
            <span>&#9790;</span>
            <div class="theme-toggle" onclick="toggleTheme()"></div>
            <span>&#9788;</span>
        </div>
    </div>
</header>

<div class="main-content">
    <div class="filter-panel">
        <!-- CATEGORIE -->
        <div class="filter-row">
            <span class="filter-label">Categorie</span>
            <div class="filter-btns" id="catBtns">
                <!-- Categorie predefinite -->
                <button class="cat-btn active" data-cat="nasdaq" onclick="toggleCat(this)">NASDAQ</button>
                <button class="cat-btn" data-cat="sp500" onclick="toggleCat(this)">S&amp;P 500</button>
                <button class="cat-btn" data-cat="italia" onclick="toggleCat(this)">Borsa Italiana</button>
                <button class="cat-btn" data-cat="cinesi" onclick="toggleCat(this)">Titoli Cinesi</button>
                <button class="cat-btn" data-cat="europee" onclick="toggleCat(this)">Europee</button>
                <button class="cat-btn" data-cat="crypto" onclick="toggleCat(this)">Crypto</button>
                <button class="cat-btn" data-cat="commodities" onclick="toggleCat(this)">Materie Prime</button>
                <button class="cat-btn" data-cat="forex" onclick="toggleCat(this)">Forex</button>
                <button class="cat-btn" data-cat="indici" onclick="toggleCat(this)">Indici</button>
                <!-- Le categorie custom vengono inserite qui dal JS -->
            </div>
            <button class="btn-selall" id="btnSelAll" onclick="toggleSelectAll()">Tutte</button>
            <button class="btn-new-cat" onclick="openNewCatModal()">+ Nuova categoria</button>
        </div>

        <!-- PERIODO -->
        <div class="filter-row">
            <span class="filter-label">Periodo</span>
            <div class="filter-btns">
                <button class="period-btn" data-period="2d"  data-interval="1d">1 Giorno</button>
                <button class="period-btn" data-period="5d"  data-interval="1d">1 Settimana</button>
                <button class="period-btn active" data-period="1mo" data-interval="1d">1 Mese</button>
                <button class="period-btn" data-period="3mo" data-interval="1d">3 Mesi</button>
                <button class="period-btn" data-period="6mo" data-interval="1wk">6 Mesi</button>
                <button class="period-btn" data-period="1y"  data-interval="1wk">1 Anno</button>
                <button class="period-btn" data-period="ytd" data-interval="1d">YTD</button>
            </div>
        </div>

        <!-- LIMITE ASSET PER CATEGORIA -->
        <div class="filter-row">
            <span class="filter-label">Asset per cat.</span>
            <div class="filter-btns">
                <button class="limit-btn" data-limit="5">5</button>
                <button class="limit-btn" data-limit="10">10</button>
                <button class="limit-btn" data-limit="20">20</button>
                <button class="limit-btn" data-limit="50">50</button>
                <button class="limit-btn active" data-limit="0">Tutti</button>
                <input type="number" id="limitCustom" class="limit-input"
                    min="1" max="999" placeholder="N…" title="Numero personalizzato">
            </div>
        </div>

        <!-- CARICA -->
        <div class="load-row">
            <button class="btn-load" id="loadBtn" onclick="loadRanking()">Carica Classifica</button>
            <span class="progress-text" id="progressText"></span>
        </div>
    </div>

    <!-- RISULTATI HEADER -->
    <div id="resultsHeader" class="results-header" style="display:none">
        <span class="sort-label">Ordina:</span>
        <button class="sort-btn active" id="btnDesc" onclick="sortResults('desc')">Migliori prima &#8593;</button>
        <button class="sort-btn" id="btnAsc" onclick="sortResults('asc')">Peggiori prima &#8595;</button>
        <span class="results-info" id="resultsInfo"></span>
    </div>

    <div id="resultsArea">
        <div class="status-box">
            Seleziona le categorie e il periodo, poi clicca <strong>Carica Classifica</strong>
        </div>
    </div>
</div>

<!-- MODAL: Nuova / Modifica categoria -->
<div class="modal-overlay" id="catModal">
    <div class="modal">
        <h2 id="catModalTitle">Nuova Categoria</h2>
        <div class="modal-field">
            <label>Nome categoria</label>
            <input type="text" id="catModalName" placeholder="es. I Miei Preferiti" maxlength="24">
        </div>
        <div class="modal-field">
            <label>Cerca e aggiungi asset</label>
            <div class="asset-search-wrap">
                <input type="text" id="assetSearch" class="asset-search-input"
                    placeholder="Cerca per nome o simbolo… (es. Apple, AAPL, Bitcoin, Eni)"
                    autocomplete="off" oninput="assetSearchInput()" onkeydown="assetSearchKeyDown(event)">
                <div class="asset-dropdown" id="assetDropdown"></div>
            </div>
        </div>
        <div class="asset-tags" id="assetTags">
            <span class="tags-empty">Nessun asset aggiunto — cerca sopra o premi Invio per aggiungere un simbolo personalizzato</span>
        </div>
        <div class="modal-hint">
            Non trovi il simbolo? Scrivi direttamente <code>SIMBOLO</code> o <code>SIMBOLO Nome</code> e premi <strong>Invio</strong>.
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeCatModal()">Annulla</button>
            <button class="btn-save" onclick="saveCatModal()">Salva</button>
        </div>
    </div>
</div>

<script>
// ==================== ASSET DEFINITIONS ====================
const ASSETS = {
    nasdaq: {
        label: 'NASDAQ', pillClass: 'pill-nasdaq',
        items: [
            {symbol:'AAPL',name:'Apple'},{symbol:'MSFT',name:'Microsoft'},
            {symbol:'NVDA',name:'NVIDIA'},{symbol:'AMZN',name:'Amazon'},
            {symbol:'META',name:'Meta'},{symbol:'GOOGL',name:'Alphabet'},
            {symbol:'TSLA',name:'Tesla'},{symbol:'AVGO',name:'Broadcom'},
            {symbol:'NFLX',name:'Netflix'},{symbol:'AMD',name:'AMD'},
            {symbol:'ADBE',name:'Adobe'},{symbol:'QCOM',name:'Qualcomm'},
            {symbol:'COST',name:'Costco'},{symbol:'INTC',name:'Intel'},
            {symbol:'CSCO',name:'Cisco'},{symbol:'PYPL',name:'PayPal'},
            {symbol:'SBUX',name:'Starbucks'},{symbol:'ORCL',name:'Oracle'},
            {symbol:'INTU',name:'Intuit'},{symbol:'AMAT',name:'Applied Materials'},
            {symbol:'PANW',name:'Palo Alto Networks'},{symbol:'MRVL',name:'Marvell Technology'},
            {symbol:'KLAC',name:'KLA Corporation'},{symbol:'LRCX',name:'Lam Research'},
            {symbol:'SNPS',name:'Synopsys'},{symbol:'CDNS',name:'Cadence Design'},
            {symbol:'MELI',name:'MercadoLibre'},{symbol:'ABNB',name:'Airbnb'},
            {symbol:'BKNG',name:'Booking Holdings'},{symbol:'CRWD',name:'CrowdStrike'},
            {symbol:'DDOG',name:'Datadog'},{symbol:'MDB',name:'MongoDB'},
            {symbol:'SNOW',name:'Snowflake'},{symbol:'TEAM',name:'Atlassian'},
            {symbol:'WDAY',name:'Workday'},{symbol:'SHOP',name:'Shopify'},
            {symbol:'COIN',name:'Coinbase'},{symbol:'ZS',name:'Zscaler'},
            {symbol:'ON',name:'ON Semiconductor'},{symbol:'ARM',name:'ARM Holdings'},
            {symbol:'SMCI',name:'Super Micro Computer'},{symbol:'FAST',name:'Fastenal'},
            {symbol:'PAYX',name:'Paychex'},{symbol:'REGN',name:'Regeneron'},
            {symbol:'VRTX',name:'Vertex Pharmaceuticals'},{symbol:'PCAR',name:'PACCAR'},
            {symbol:'ROST',name:'Ross Stores'},{symbol:'CSGP',name:'CoStar Group'},
            {symbol:'NXPI',name:'NXP Semiconductors'},{symbol:'PLTR',name:'Palantir'}
        ]
    },
    sp500: {
        label: 'S&P 500', pillClass: 'pill-sp500',
        items: [
            {symbol:'JPM',name:'JPMorgan Chase'},{symbol:'V',name:'Visa'},
            {symbol:'WMT',name:'Walmart'},{symbol:'MA',name:'Mastercard'},
            {symbol:'XOM',name:'ExxonMobil'},{symbol:'JNJ',name:'Johnson & Johnson'},
            {symbol:'PG',name:'Procter & Gamble'},{symbol:'UNH',name:'UnitedHealth'},
            {symbol:'HD',name:'Home Depot'},{symbol:'CVX',name:'Chevron'},
            {symbol:'MRK',name:'Merck'},{symbol:'BAC',name:'Bank of America'},
            {symbol:'KO',name:'Coca-Cola'},{symbol:'LLY',name:'Eli Lilly'},
            {symbol:'ABBV',name:'AbbVie'},{symbol:'PFE',name:'Pfizer'},
            {symbol:'DIS',name:'Walt Disney'},{symbol:'MCD',name:"McDonald's"},
            {symbol:'WFC',name:'Wells Fargo'},{symbol:'GS',name:'Goldman Sachs'},
            {symbol:'BRK-B',name:'Berkshire Hathaway'},{symbol:'RTX',name:'RTX'},
            {symbol:'HON',name:'Honeywell'},{symbol:'CAT',name:'Caterpillar'},
            {symbol:'BA',name:'Boeing'},{symbol:'GE',name:'GE Aerospace'},
            {symbol:'IBM',name:'IBM'},{symbol:'CRM',name:'Salesforce'},
            {symbol:'NEE',name:'NextEra Energy'},{symbol:'T',name:'AT&T'},
            {symbol:'VZ',name:'Verizon'},{symbol:'CMCSA',name:'Comcast'},
            {symbol:'BMY',name:'Bristol-Myers Squibb'},{symbol:'AMGN',name:'Amgen'},
            {symbol:'MDT',name:'Medtronic'},{symbol:'ABT',name:'Abbott'},
            {symbol:'TMO',name:'Thermo Fisher'},{symbol:'LMT',name:'Lockheed Martin'},
            {symbol:'COP',name:'ConocoPhillips'},{symbol:'USB',name:'US Bancorp'},
            {symbol:'MS',name:'Morgan Stanley'},{symbol:'AXP',name:'American Express'},
            {symbol:'BLK',name:'BlackRock'},{symbol:'SPGI',name:'S&P Global'},
            {symbol:'SO',name:'Southern Company'},{symbol:'DUK',name:'Duke Energy'},
            {symbol:'SLB',name:'SLB'},{symbol:'MMM',name:'3M'},
            {symbol:'DHR',name:'Danaher'},{symbol:'NOC',name:'Northrop Grumman'}
        ]
    },
    italia: {
        label: 'Borsa IT', pillClass: 'pill-italia',
        items: [
            {symbol:'ENI.MI',name:'Eni'},{symbol:'ENEL.MI',name:'Enel'},
            {symbol:'ISP.MI',name:'Intesa Sanpaolo'},{symbol:'UCG.MI',name:'UniCredit'},
            {symbol:'STM.MI',name:'STMicroelectronics'},{symbol:'G.MI',name:'Generali'},
            {symbol:'STLAM.MI',name:'Stellantis'},{symbol:'TIT.MI',name:'Telecom Italia'},
            {symbol:'MB.MI',name:'Mediobanca'},{symbol:'FBK.MI',name:'FinecoBank'},
            {symbol:'LDO.MI',name:'Leonardo'},{symbol:'MONC.MI',name:'Moncler'},
            {symbol:'RACE.MI',name:'Ferrari'},{symbol:'BMED.MI',name:'Banca Mediolanum'},
            {symbol:'CNHI.MI',name:'CNH Industrial'},{symbol:'HER.MI',name:'Hera'},
            {symbol:'INW.MI',name:'Inwit'},{symbol:'AMP.MI',name:'Amplifon'},
            {symbol:'PRY.MI',name:'Prysmian'},{symbol:'CPR.MI',name:'Azimut'},
            {symbol:'PST.MI',name:'Poste Italiane'},{symbol:'REC.MI',name:'Recordati'},
            {symbol:'DIA.MI',name:'DiaSorin'},{symbol:'BAMI.MI',name:'Banco BPM'},
            {symbol:'BMPS.MI',name:'Monte dei Paschi'},{symbol:'A2A.MI',name:'A2A'},
            {symbol:'SRG.MI',name:'Snam'},{symbol:'ERG.MI',name:'ERG'},
            {symbol:'BPER.MI',name:'BPER Banca'},{symbol:'BGN.MI',name:'Banca Generali'},
            {symbol:'TEN.MI',name:'Tenaris'},{symbol:'SPM.MI',name:'Saipem'},
            {symbol:'PIRC.MI',name:'Pirelli'},{symbol:'DLG.MI',name:"De'Longhi"},
            {symbol:'IP.MI',name:'Interpump'},{symbol:'IG.MI',name:'Italgas'},
            {symbol:'IRE.MI',name:'IREN'},{symbol:'BZU.MI',name:'Buzzi'},
            {symbol:'NEXI.MI',name:'Nexi'},{symbol:'EXO.MI',name:'Exor'}
        ]
    },
    cinesi: {
        label: 'Cinesi', pillClass: 'pill-cinesi',
        items: [
            {symbol:'BABA',name:'Alibaba'},{symbol:'JD',name:'JD.com'},
            {symbol:'BIDU',name:'Baidu'},{symbol:'PDD',name:'PDD (Temu)'},
            {symbol:'NIO',name:'NIO'},{symbol:'XPEV',name:'XPeng'},
            {symbol:'LI',name:'Li Auto'},{symbol:'TME',name:'Tencent Music'},
            {symbol:'NTES',name:'NetEase'},{symbol:'YUMC',name:'Yum China'},
            {symbol:'EDU',name:'New Oriental'},{symbol:'FUTU',name:'Futu Holdings'},
            {symbol:'IQ',name:'iQIYI'},{symbol:'MNSO',name:'MINISO'},{symbol:'ZH',name:'Zhihu'},
            {symbol:'TCOM',name:'Trip.com'},{symbol:'BILI',name:'Bilibili'},
            {symbol:'VIPS',name:'Vipshop'},{symbol:'WB',name:'Weibo'},
            {symbol:'TAL',name:'TAL Education'},{symbol:'BEKE',name:'KE Holdings'},
            {symbol:'GDS',name:'GDS Holdings'},{symbol:'DOYU',name:'DouYu'},
            {symbol:'HUYA',name:'Huya'},{symbol:'RLX',name:'RLX Technology'},
            {symbol:'KC',name:'Kingsoft Cloud'},{symbol:'TIGR',name:'UP Fintech'},
            {symbol:'GOTU',name:'Gaotu Techedu'},{symbol:'CAN',name:'Canaan'},
            {symbol:'HTHT',name:'H World Group'},{symbol:'DQ',name:'Daqo New Energy'},
            {symbol:'BGNE',name:'BeiGene'},{symbol:'LU',name:'Lufax'},
            {symbol:'CANG',name:'Cango'},{symbol:'LAIX',name:'LAIX'}
        ]
    },
    europee: {
        label: 'Europee', pillClass: 'pill-europee',
        items: [
            {symbol:'ASML.AS',name:'ASML'},{symbol:'SAP.DE',name:'SAP'},
            {symbol:'NESN.SW',name:'Nestlé'},{symbol:'MC.PA',name:'LVMH'},
            {symbol:'OR.PA',name:"L'Oréal"},{symbol:'SIE.DE',name:'Siemens'},
            {symbol:'TTE.PA',name:'TotalEnergies'},{symbol:'NOVN.SW',name:'Novartis'},
            {symbol:'ALV.DE',name:'Allianz'},{symbol:'BNP.PA',name:'BNP Paribas'},
            {symbol:'AZN.L',name:'AstraZeneca'},{symbol:'AIR.PA',name:'Airbus'},
            {symbol:'VOW3.DE',name:'Volkswagen'},{symbol:'BMW.DE',name:'BMW'},
            {symbol:'ROG.SW',name:'Roche'},
            {symbol:'HSBA.L',name:'HSBC'},{symbol:'GSK.L',name:'GSK'},
            {symbol:'BP.L',name:'BP'},{symbol:'SHEL.L',name:'Shell'},
            {symbol:'ULVR.L',name:'Unilever'},{symbol:'DGE.L',name:'Diageo'},
            {symbol:'BARC.L',name:'Barclays'},{symbol:'RIO.L',name:'Rio Tinto'},
            {symbol:'BAS.DE',name:'BASF'},{symbol:'DBK.DE',name:'Deutsche Bank'},
            {symbol:'MUV2.DE',name:'Munich Re'},{symbol:'DTE.DE',name:'Deutsche Telekom'},
            {symbol:'ADS.DE',name:'Adidas'},{symbol:'BAYN.DE',name:'Bayer'},
            {symbol:'MBG.DE',name:'Mercedes-Benz'},{symbol:'PAH3.DE',name:'Porsche'},
            {symbol:'SAN.PA',name:'Sanofi'},{symbol:'KER.PA',name:'Kering'},
            {symbol:'RMS.PA',name:'Hermès'},{symbol:'AXA.PA',name:'AXA'},
            {symbol:'DSY.PA',name:'Dassault Systèmes'},{symbol:'SU.PA',name:'Schneider Electric'},
            {symbol:'ORA.PA',name:'Orange'},{symbol:'CAP.PA',name:'Capgemini'},
            {symbol:'INGA.AS',name:'ING'},{symbol:'HEIA.AS',name:'Heineken'},
            {symbol:'AD.AS',name:'Ahold Delhaize'},
            {symbol:'ABBN.SW',name:'ABB'},{symbol:'ZURN.SW',name:'Zurich Insurance'},
            {symbol:'CFR.SW',name:'Richemont'},{symbol:'LONN.SW',name:'Lonza'},
            {symbol:'SAN.MC',name:'Santander'},{symbol:'BBVA.MC',name:'BBVA'},
            {symbol:'TEF.MC',name:'Telefonica'},{symbol:'UCB.BR',name:'UCB'}
        ]
    },
    crypto: {
        label: 'Crypto', pillClass: 'pill-crypto',
        items: [
            {symbol:'BTC-USD',name:'Bitcoin'},{symbol:'ETH-USD',name:'Ethereum'},
            {symbol:'BNB-USD',name:'BNB'},{symbol:'SOL-USD',name:'Solana'},
            {symbol:'XRP-USD',name:'XRP'},{symbol:'ADA-USD',name:'Cardano'},
            {symbol:'DOGE-USD',name:'Dogecoin'},{symbol:'AVAX-USD',name:'Avalanche'},
            {symbol:'DOT-USD',name:'Polkadot'},{symbol:'LINK-USD',name:'Chainlink'},
            {symbol:'LTC-USD',name:'Litecoin'},{symbol:'BCH-USD',name:'Bitcoin Cash'},
            {symbol:'ATOM-USD',name:'Cosmos'},{symbol:'UNI-USD',name:'Uniswap'},
            {symbol:'MATIC-USD',name:'Polygon'},
            {symbol:'SHIB-USD',name:'Shiba Inu'},{symbol:'TRX-USD',name:'TRON'},
            {symbol:'ICP-USD',name:'Internet Computer'},{symbol:'FIL-USD',name:'Filecoin'},
            {symbol:'NEAR-USD',name:'NEAR Protocol'},{symbol:'ALGO-USD',name:'Algorand'},
            {symbol:'HBAR-USD',name:'Hedera'},{symbol:'SAND-USD',name:'The Sandbox'},
            {symbol:'MANA-USD',name:'Decentraland'},{symbol:'AXS-USD',name:'Axie Infinity'},
            {symbol:'AAVE-USD',name:'Aave'},{symbol:'MKR-USD',name:'Maker'},
            {symbol:'VET-USD',name:'VeChain'},{symbol:'XLM-USD',name:'Stellar'},
            {symbol:'EOS-USD',name:'EOS'},{symbol:'GRT-USD',name:'The Graph'},
            {symbol:'APT-USD',name:'Aptos'},{symbol:'SUI-USD',name:'Sui'},
            {symbol:'FTM-USD',name:'Fantom'},{symbol:'XMR-USD',name:'Monero'},
            {symbol:'CRV-USD',name:'Curve'},{symbol:'RUNE-USD',name:'THORChain'},
            {symbol:'LDO-USD',name:'Lido DAO'},{symbol:'COMP-USD',name:'Compound'},
            {symbol:'ENJ-USD',name:'Enjin'},{symbol:'FLOW-USD',name:'Flow'},
            {symbol:'CHZ-USD',name:'Chiliz'},{symbol:'GALA-USD',name:'Gala'},
            {symbol:'IMX-USD',name:'Immutable X'},{symbol:'ZEC-USD',name:'Zcash'},
            {symbol:'ZIL-USD',name:'Zilliqa'},{symbol:'SNX-USD',name:'Synthetix'},
            {symbol:'YFI-USD',name:'Yearn Finance'},{symbol:'BAT-USD',name:'Basic Attention Token'}
        ]
    },
    commodities: {
        label: 'Materie Prime', pillClass: 'pill-commodities',
        items: [
            {symbol:'GC=F',name:'Oro'},{symbol:'SI=F',name:'Argento'},
            {symbol:'CL=F',name:'Petrolio WTI'},{symbol:'BZ=F',name:'Petrolio Brent'},
            {symbol:'NG=F',name:'Gas Naturale'},{symbol:'HG=F',name:'Rame'},
            {symbol:'ZW=F',name:'Grano'},{symbol:'ZC=F',name:'Mais'},
            {symbol:'PL=F',name:'Platino'},{symbol:'PA=F',name:'Palladio'},
            {symbol:'ZS=F',name:'Soia'},{symbol:'KC=F',name:'Caffè'},
            {symbol:'CT=F',name:'Cotone'},{symbol:'SB=F',name:'Zucchero'},
            {symbol:'CC=F',name:'Cacao'},{symbol:'OJ=F',name:"Succo d'Arancia"},
            {symbol:'LE=F',name:'Bovini Vivi'},{symbol:'HE=F',name:'Suini'},
            {symbol:'RB=F',name:'Benzina RBOB'},{symbol:'HO=F',name:'Gasolio'},
            {symbol:'ZL=F',name:'Olio di Soia'},{symbol:'ZM=F',name:'Farina di Soia'},
            {symbol:'ALI=F',name:'Alluminio'},{symbol:'LBS=F',name:'Legname'},
            {symbol:'ZO=F',name:'Avena'}
        ]
    },
    forex: {
        label: 'Forex', pillClass: 'pill-forex',
        items: [
            {symbol:'EURUSD=X',name:'EUR/USD'},{symbol:'GBPUSD=X',name:'GBP/USD'},
            {symbol:'USDJPY=X',name:'USD/JPY'},{symbol:'USDCHF=X',name:'USD/CHF'},
            {symbol:'AUDUSD=X',name:'AUD/USD'},{symbol:'USDCAD=X',name:'USD/CAD'},
            {symbol:'EURGBP=X',name:'EUR/GBP'},{symbol:'EURJPY=X',name:'EUR/JPY'},
            {symbol:'NZDUSD=X',name:'NZD/USD'},{symbol:'GBPJPY=X',name:'GBP/JPY'},
            {symbol:'USDCNY=X',name:'USD/CNY'},{symbol:'USDINR=X',name:'USD/INR'},
            {symbol:'USDMXN=X',name:'USD/MXN'},{symbol:'USDBRL=X',name:'USD/BRL'},
            {symbol:'USDKRW=X',name:'USD/KRW'},{symbol:'EURAUD=X',name:'EUR/AUD'},
            {symbol:'EURNZD=X',name:'EUR/NZD'},{symbol:'EURCAD=X',name:'EUR/CAD'},
            {symbol:'GBPAUD=X',name:'GBP/AUD'},{symbol:'AUDCAD=X',name:'AUD/CAD'}
        ]
    },
    indici: {
        label: 'Indici', pillClass: 'pill-indici',
        items: [
            {symbol:'^GSPC',name:'S&P 500'},{symbol:'^IXIC',name:'NASDAQ Composite'},
            {symbol:'^DJI',name:'Dow Jones'},{symbol:'^FTSE',name:'FTSE 100'},
            {symbol:'^GDAXI',name:'DAX 40'},{symbol:'^FCHI',name:'CAC 40'},
            {symbol:'^N225',name:'Nikkei 225'},{symbol:'^HSI',name:'Hang Seng'},
            {symbol:'^STOXX50E',name:'Euro Stoxx 50'},{symbol:'^RUT',name:'Russell 2000'},
            {symbol:'000001.SS',name:'Shanghai Composite'},{symbol:'^BSESN',name:'BSE Sensex'},
            {symbol:'^AXJO',name:'ASX 200'},{symbol:'^TWII',name:'Taiwan Weighted'},
            {symbol:'^KS11',name:'KOSPI'},{symbol:'^NSEI',name:'Nifty 50'},
            {symbol:'^MXX',name:'IPC Mexico'},{symbol:'^BVSP',name:'Bovespa'},
            {symbol:'^AEX',name:'AEX Amsterdam'},{symbol:'^IBEX',name:'IBEX 35'},
            {symbol:'^ATX',name:'ATX Vienna'},{symbol:'^BFX',name:'BEL 20'},
            {symbol:'^SSMI',name:'SMI Svizzera'},{symbol:'^JKSE',name:'IDX Composite'},
            {symbol:'^TA125.TA',name:'TA-125 Tel Aviv'}
        ]
    }
};

// Palette colori per categorie custom
const CUSTOM_COLORS = ['#6a1b9a','#2e7d32','#00838f','#ad1457','#bf360c','#1565c0','#37474f','#558b2f','#4a148c','#006064'];

// ==================== STATE ====================
let isDark = true;
let rankingData = [];
let currentSort = 'desc';
let customCats = {};
let modalEditKey = null;
let modalSelectedItems = [];
let allAssetsFlat = [];
let dropdownItems = [];

// ==================== THEME ====================
function toggleTheme() {
    isDark = !isDark;
    document.documentElement.classList.toggle('light', !isDark);
    try {
        const d = localStorage.getItem('dashboardBorsa');
        if (d) { const p = JSON.parse(d); p.dark = isDark; localStorage.setItem('dashboardBorsa', JSON.stringify(p)); }
    } catch(e) {}
}
function loadTheme() {
    try {
        const d = localStorage.getItem('dashboardBorsa');
        if (d) { const p = JSON.parse(d); if (p.dark !== undefined) isDark = p.dark; }
    } catch(e) {}
    document.documentElement.classList.toggle('light', !isDark);
}

// ==================== CUSTOM CATEGORIES ====================
const CUSTOM_CATS_KEY = 'rankingCustomCats';

function loadCustomCats() {
    try {
        const d = localStorage.getItem(CUSTOM_CATS_KEY);
        if (d) customCats = JSON.parse(d);
    } catch(e) { customCats = {}; }
}

function saveCustomCats() {
    try { localStorage.setItem(CUSTOM_CATS_KEY, JSON.stringify(customCats)); } catch(e) {}
}

function getCustomColor(key) {
    const keys = Object.keys(customCats);
    const idx = keys.indexOf(key);
    return CUSTOM_COLORS[idx >= 0 ? idx % CUSTOM_COLORS.length : 0];
}

function parseSymbolsText(text) {
    const items = [];
    const seen = new Set();
    const lines = text.replace(/,\s*/g, '\n').split('\n');
    for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed) continue;
        const parts = trimmed.split(/\s+/);
        const symbol = parts[0].toUpperCase();
        if (!symbol || seen.has(symbol)) continue;
        seen.add(symbol);
        const name = parts.slice(1).join(' ').trim() || symbol;
        items.push({ symbol, name });
    }
    return items;
}

function renderCustomCatButtons() {
    const container = document.getElementById('catBtns');
    // Rimuovi i wrapper custom esistenti
    container.querySelectorAll('.custom-cat-wrapper').forEach(el => el.remove());

    let colorIdx = 0;
    for (const key in customCats) {
        const cat = customCats[key];
        const color = CUSTOM_COLORS[colorIdx % CUSTOM_COLORS.length];
        colorIdx++;

        const wrapper = document.createElement('div');
        wrapper.className = 'custom-cat-wrapper';

        const btn = document.createElement('button');
        btn.className = 'cat-btn';
        btn.dataset.cat = key;
        btn.style.cssText = 'border-left: 3px solid ' + color + ';';
        btn.textContent = cat.label;
        btn.setAttribute('onclick', 'toggleCat(this)');

        const actions = document.createElement('div');
        actions.className = 'custom-cat-actions';

        const btnEdit = document.createElement('button');
        btnEdit.textContent = '✎ Modifica';
        btnEdit.addEventListener('click', (e) => { e.stopPropagation(); openEditCatModal(key); });

        const btnDel = document.createElement('button');
        btnDel.textContent = '✕ Elimina';
        btnDel.className = 'danger';
        btnDel.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteCustomCat(key, wrapper, btn);
        });

        actions.append(btnEdit, btnDel);
        wrapper.append(btn, actions);
        container.appendChild(wrapper);
    }
    updateSelAllBtn();
}

function deleteCustomCat(key, wrapper, btn) {
    if (!confirm('Eliminare la categoria "' + customCats[key].label + '"?')) return;
    delete customCats[key];
    saveCustomCats();
    wrapper.remove();
    updateSelAllBtn();
}

// ==================== MODAL CATEGORIE ====================
function openNewCatModal() {
    modalEditKey = null;
    modalSelectedItems = [];
    document.getElementById('catModalTitle').textContent = 'Nuova Categoria';
    document.getElementById('catModalName').value = '';
    document.getElementById('assetSearch').value = '';
    closeAssetDropdown();
    renderModalTags();
    document.getElementById('catModal').classList.add('open');
    document.getElementById('catModalName').focus();
}

function openEditCatModal(key) {
    modalEditKey = key;
    const cat = customCats[key];
    modalSelectedItems = cat.items.map(i => ({ symbol: i.symbol, name: i.name }));
    document.getElementById('catModalTitle').textContent = 'Modifica Categoria';
    document.getElementById('catModalName').value = cat.label;
    document.getElementById('assetSearch').value = '';
    closeAssetDropdown();
    renderModalTags();
    document.getElementById('catModal').classList.add('open');
    document.getElementById('catModalName').focus();
}

function closeCatModal() {
    document.getElementById('catModal').classList.remove('open');
    modalEditKey = null;
    closeAssetDropdown();
}

function saveCatModal() {
    const name = document.getElementById('catModalName').value.trim();
    if (!name) { document.getElementById('catModalName').focus(); alert('Inserisci il nome della categoria'); return; }
    if (!modalSelectedItems.length) { document.getElementById('assetSearch').focus(); alert('Aggiungi almeno un asset'); return; }
    const items = modalSelectedItems.map(i => ({ symbol: i.symbol, name: i.name }));
    if (modalEditKey) {
        customCats[modalEditKey].label = name;
        customCats[modalEditKey].items = items;
    } else {
        customCats['cc_' + Date.now()] = { label: name, items };
    }
    saveCustomCats();
    renderCustomCatButtons();
    closeCatModal();
}

// ==================== ASSET AUTOCOMPLETE ====================
function buildAllAssets() {
    allAssetsFlat = [];
    for (const k in ASSETS) {
        for (const item of ASSETS[k].items) {
            allAssetsFlat.push({ symbol: item.symbol, name: item.name, catLabel: ASSETS[k].label });
        }
    }
}

function assetSearchInput() {
    const inp = document.getElementById('assetSearch');
    const q = inp.value.trim().toLowerCase();
    if (!q) { closeAssetDropdown(); return; }
    const filtered = allAssetsFlat
        .filter(a => (a.symbol.toLowerCase().includes(q) || a.name.toLowerCase().includes(q))
                  && !modalSelectedItems.some(s => s.symbol === a.symbol))
        .slice(0, 10);
    dropdownItems = filtered;
    const rawQ = inp.value.trim();
    const symUp = rawQ.split(/\s+/)[0].toUpperCase();
    let html = filtered.map((item, i) =>
        '<div class="asset-dropdown-item" data-idx="' + i + '">' +
        '<span class="adi-symbol">' + escapeHtml(item.symbol) + '</span>' +
        '<span class="adi-name">'   + escapeHtml(item.name)   + '</span>' +
        '<span class="adi-cat">'    + escapeHtml(item.catLabel) + '</span>' +
        '</div>'
    ).join('');
    if (symUp) {
        const nameHint = rawQ.includes(' ') ? ' — <em>' + escapeHtml(rawQ) + '</em>' : '';
        html += '<div class="asset-dropdown-item custom-add" data-idx="-1">' +
            '+ Aggiungi <strong>' + escapeHtml(symUp) + '</strong>' + nameHint + ' come simbolo personalizzato' +
            '</div>';
    }
    const dd = document.getElementById('assetDropdown');
    dd.innerHTML = html;
    dd.classList.add('open');
}

function assetSearchKeyDown(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const first = document.querySelector('#assetDropdown .asset-dropdown-item:not(.custom-add)');
        if (first) {
            const idx = parseInt(first.dataset.idx);
            if (!isNaN(idx) && dropdownItems[idx]) addAssetToModal(dropdownItems[idx].symbol, dropdownItems[idx].name);
        } else {
            addCustomAssetToModal();
        }
    } else if (e.key === 'Escape') {
        if (document.getElementById('assetDropdown').classList.contains('open')) closeAssetDropdown();
        else closeCatModal();
    }
}

function closeAssetDropdown() {
    const dd = document.getElementById('assetDropdown');
    if (dd) dd.classList.remove('open');
}

function addAssetToModal(symbol, name) {
    if (!modalSelectedItems.some(i => i.symbol === symbol)) {
        modalSelectedItems.push({ symbol, name });
        renderModalTags();
    }
    document.getElementById('assetSearch').value = '';
    closeAssetDropdown();
    document.getElementById('assetSearch').focus();
}

function addCustomAssetToModal() {
    const raw = document.getElementById('assetSearch').value.trim();
    if (!raw) return;
    const parts = raw.split(/\s+/);
    addAssetToModal(parts[0].toUpperCase(), parts.slice(1).join(' ') || parts[0].toUpperCase());
}

function removeAssetFromModal(idx) {
    modalSelectedItems.splice(idx, 1);
    renderModalTags();
}

function renderModalTags() {
    const container = document.getElementById('assetTags');
    if (!container) return;
    if (!modalSelectedItems.length) {
        container.innerHTML = '<span class="tags-empty">Nessun asset aggiunto — cerca sopra o premi Invio per aggiungere un simbolo personalizzato</span>';
        return;
    }
    container.innerHTML = modalSelectedItems.map((item, i) =>
        '<span class="asset-tag" data-idx="' + i + '">' +
        '<span class="asset-tag-sym">'  + escapeHtml(item.symbol) + '</span>' +
        (item.name !== item.symbol ? '<span class="asset-tag-name">' + escapeHtml(item.name) + '</span>' : '') +
        '<span class="asset-tag-remove" title="Rimuovi">&#x2715;</span>' +
        '</span>'
    ).join('');
}

// Chiudi dropdown cliccando fuori
document.addEventListener('click', function(e) {
    if (!e.target.closest('.asset-search-wrap')) closeAssetDropdown();
});

// Delegazione click sul dropdown
document.addEventListener('click', function(e) {
    const item = e.target.closest('#assetDropdown .asset-dropdown-item');
    if (!item) return;
    const idx = parseInt(item.dataset.idx);
    if (idx >= 0 && dropdownItems[idx]) addAssetToModal(dropdownItems[idx].symbol, dropdownItems[idx].name);
    else addCustomAssetToModal();
});

// Delegazione click sui tag (rimozione)
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.asset-tag-remove');
    if (!btn) return;
    const tag = btn.closest('.asset-tag');
    if (tag) removeAssetFromModal(parseInt(tag.dataset.idx));
});

// Chiudi modal cliccando overlay
document.getElementById('catModal').addEventListener('click', function(e) {
    if (e.target === this) closeCatModal();
});
document.getElementById('catModalName').addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeCatModal();
});

// ==================== FILTERS ====================
document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    });
});
document.querySelectorAll('.limit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.limit-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const inp = document.getElementById('limitCustom');
        inp.value = '';
        inp.classList.remove('active');
    });
});
(function() {
    const inp = document.getElementById('limitCustom');
    inp.addEventListener('input', () => {
        const v = inp.value.trim();
        if (v && parseInt(v) > 0) {
            document.querySelectorAll('.limit-btn').forEach(b => b.classList.remove('active'));
            inp.classList.add('active');
        } else {
            inp.classList.remove('active');
            // se svuotato, riattiva Tutti
            if (!v) {
                document.querySelectorAll('.limit-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.limit-btn[data-limit="0"]').classList.add('active');
            }
        }
    });
    inp.addEventListener('keydown', e => { if (e.key === 'Enter') loadRanking(); });
})();
function toggleCat(btn) {
    btn.classList.toggle('active');
    updateSelAllBtn();
}

function updateSelAllBtn() {
    const all = document.querySelectorAll('#catBtns .cat-btn');
    const active = document.querySelectorAll('#catBtns .cat-btn.active');
    document.getElementById('btnSelAll').textContent = (active.length === all.length && all.length > 0) ? 'Rimuovi tutte' : 'Tutte';
}

function toggleSelectAll() {
    const all = document.querySelectorAll('#catBtns .cat-btn');
    const active = document.querySelectorAll('#catBtns .cat-btn.active');
    const selectAll = active.length !== all.length;
    all.forEach(btn => btn.classList.toggle('active', selectAll));
    updateSelAllBtn();
}

// ==================== HELPERS ====================
function getAllCats() {
    const all = {};
    for (const key in ASSETS) all[key] = ASSETS[key];
    let colorIdx = 0;
    for (const key in customCats) {
        all[key] = {
            label: customCats[key].label,
            pillClass: '',
            pillStyle: CUSTOM_COLORS[colorIdx % CUSTOM_COLORS.length],
            items: customCats[key].items,
            isCustom: true
        };
        colorIdx++;
    }
    return all;
}

function escapeHtml(s) {
    return String(s || '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// ==================== API ====================
async function fetchWithTimeout(url, options, ms) {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), ms || 5000);
    try { return await fetch(url, { ...options, signal: ctrl.signal }); }
    finally { clearTimeout(t); }
}

async function fetchJson(url, ms) {
    const proxies = [
        url,
        'https://corsproxy.io/?' + encodeURIComponent(url),
        'https://api.allorigins.win/raw?url=' + encodeURIComponent(url)
    ];
    const attempts = proxies.map(async u => {
        const res = await fetchWithTimeout(u, { headers: { Accept: 'application/json' } }, ms || 5000);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const txt = await res.text();
        return JSON.parse(txt.replace(/^\uFEFF/, '').replace(/^\)\]\}',?\s*/, '').trim());
    });
    return Promise.any(attempts);
}

async function fetchPerf(symbol, range, interval) {
    const url = 'https://query2.finance.yahoo.com/v8/finance/chart/' +
        encodeURIComponent(symbol) + '?interval=' + interval + '&range=' + range;
    try {
        const data = await fetchJson(url, 7000);
        const res = data && data.chart && data.chart.result && data.chart.result[0];
        if (!res) return null;
        const meta = res.meta || {};
        const rawCloses = (res.indicators && res.indicators.quote && res.indicators.quote[0] && res.indicators.quote[0].close) || [];
        const closes = rawCloses.filter(c => c != null && isFinite(c) && c > 0);

        if (range === '2d' && meta.regularMarketChangePercent != null) {
            return { changePct: meta.regularMarketChangePercent, currentPrice: meta.regularMarketPrice || null, currency: meta.currency || '' };
        }

        const curPrice = (meta.regularMarketPrice && isFinite(meta.regularMarketPrice) && meta.regularMarketPrice > 0)
            ? meta.regularMarketPrice : null;
        if (closes.length < 1) return null;
        const startPrice = closes[0];
        const endPrice = curPrice || closes[closes.length - 1];
        if (!startPrice || !endPrice || startPrice <= 0) return null;

        return { changePct: ((endPrice - startPrice) / startPrice) * 100, currentPrice: endPrice, currency: meta.currency || '' };
    } catch(e) { return null; }
}

// ==================== LOAD ====================
async function loadRanking() {
    const selectedCatKeys = [...document.querySelectorAll('#catBtns .cat-btn.active')].map(b => b.dataset.cat);
    const periodBtn = document.querySelector('.period-btn.active');
    if (!selectedCatKeys.length) { alert('Seleziona almeno una categoria'); return; }

    const range    = periodBtn.dataset.period;
    const interval = periodBtn.dataset.interval;

    // Priorità: input custom → bottone attivo → 0 (Tutti)
    const customVal = parseInt(document.getElementById('limitCustom').value) || 0;
    const limitBtn  = document.querySelector('.limit-btn.active');
    const limit     = customVal > 0 ? customVal : (limitBtn ? parseInt(limitBtn.dataset.limit) || 0 : 0);

    const allCats = getAllCats();
    const toFetch = [];
    const seenSymbols = new Set();

    selectedCatKeys.forEach(cat => {
        const catDef = allCats[cat];
        if (!catDef) return;
        const items = limit > 0 ? catDef.items.slice(0, limit) : catDef.items;
        items.forEach(item => {
            if (seenSymbols.has(item.symbol)) return; // evita duplicati tra categorie
            seenSymbols.add(item.symbol);
            toFetch.push({
                symbol: item.symbol, name: item.name,
                cat, catLabel: catDef.label,
                pillClass: catDef.pillClass || '',
                pillStyle: catDef.pillStyle || null
            });
        });
    });

    const total = toFetch.length;
    let done = 0;

    const loadBtn = document.getElementById('loadBtn');
    loadBtn.disabled = true;
    loadBtn.textContent = 'Caricamento...';
    document.getElementById('resultsHeader').style.display = 'none';
    document.getElementById('progressText').textContent = '0 / ' + total;
    document.getElementById('resultsArea').innerHTML =
        '<div class="status-box"><div class="spinner"></div><div>Recupero dati per ' + total + ' asset...</div></div>';

    const promises = toFetch.map(async asset => {
        const perf = await fetchPerf(asset.symbol, range, interval);
        done++;
        document.getElementById('progressText').textContent = done + ' / ' + total;
        if (!perf) return null;
        return Object.assign({}, asset, perf);
    });

    const results = (await Promise.all(promises)).filter(Boolean);

    loadBtn.disabled = false;
    loadBtn.textContent = 'Aggiorna';

    if (!results.length) {
        document.getElementById('resultsArea').innerHTML =
            '<div class="status-box">Nessun dato disponibile. Controlla la connessione e riprova.</div>';
        document.getElementById('progressText').textContent = '';
        return;
    }

    document.getElementById('progressText').textContent =
        results.length + ' / ' + total + ' asset caricati';

    rankingData = results;
    currentSort = 'desc';
    document.getElementById('resultsHeader').style.display = 'flex';
    document.getElementById('btnDesc').classList.add('active');
    document.getElementById('btnAsc').classList.remove('active');
    renderRanking();
}

function sortResults(dir) {
    currentSort = dir;
    document.getElementById('btnDesc').classList.toggle('active', dir === 'desc');
    document.getElementById('btnAsc').classList.toggle('active', dir === 'asc');
    renderRanking();
}

// ==================== TRADINGVIEW SYMBOL CONVERSION ====================
function toTvSymbol(symbol) {
    // Indices
    const indicesMap = {
        '^GSPC':'SP:SPX', '^IXIC':'NASDAQ:IXIC', '^DJI':'DJ:DJI',
        '^FTSE':'TVC:UKX', '^GDAXI':'XETR:DAX', '^FCHI':'EURONEXT:PX1',
        '^N225':'TVC:NI225', '^HSI':'TVC:HSI', '^STOXX50E':'TVC:SX5E',
        '^RUT':'TVC:RUT', '^BSESN':'BSE:SENSEX', '000001.SS':'SSE:000001'
    };
    if (indicesMap[symbol]) return indicesMap[symbol];

    // Futures
    const futuresMap = {
        'GC=F':'COMEX:GC1!', 'SI=F':'COMEX:SI1!', 'CL=F':'NYMEX:CL1!',
        'BZ=F':'NYMEX:BB1!', 'NG=F':'NYMEX:NG1!', 'HG=F':'COMEX:HG1!',
        'ZW=F':'CBOT:ZW1!', 'ZC=F':'CBOT:ZC1!', 'PL=F':'NYMEX:PL1!',
        'PA=F':'NYMEX:PA1!'
    };
    if (futuresMap[symbol]) return futuresMap[symbol];

    // Forex — EURUSD=X → FX:EURUSD
    if (symbol.endsWith('=X')) return 'FX:' + symbol.slice(0, -2);

    // Crypto — BTC-USD → BINANCE:BTCUSDT
    if (symbol.endsWith('-USD')) return 'BINANCE:' + symbol.slice(0, -4) + 'USDT';

    // European exchanges
    if (symbol.endsWith('.MI')) return 'MIL:'      + symbol.slice(0, -3);
    if (symbol.endsWith('.DE')) return 'XETR:'     + symbol.slice(0, -3);
    if (symbol.endsWith('.PA')) return 'EURONEXT:' + symbol.slice(0, -3);
    if (symbol.endsWith('.SW')) return 'SIX:'      + symbol.slice(0, -3);
    if (symbol.endsWith('.AS')) return 'EURONEXT:' + symbol.slice(0, -3);
    if (symbol.endsWith('.L'))  return 'LSE:'      + symbol.slice(0, -2);
    if (symbol.endsWith('.SS')) return 'SSE:'      + symbol.slice(0, -3);

    // US stocks — pass through, TradingView auto-resolves NASDAQ/NYSE
    return symbol;
}

// ==================== RENDER ====================
function formatPrice(price, currency) {
    if (price == null || !isFinite(price)) return '—';
    const abs = Math.abs(price);
    const dec = abs < 0.0001 ? 6 : abs < 0.01 ? 5 : abs < 1 ? 4 : 2;
    const s = price.toLocaleString('it-IT', { minimumFractionDigits: dec, maximumFractionDigits: dec });
    return currency ? s + ' ' + currency : s;
}

function renderRanking() {
    const sorted = [...rankingData].sort((a, b) =>
        currentSort === 'desc' ? b.changePct - a.changePct : a.changePct - b.changePct
    );
    const maxAbs = Math.max(...sorted.map(r => Math.abs(r.changePct)), 0.001);
    document.getElementById('resultsInfo').textContent = sorted.length + ' asset';

    const rows = sorted.map((item, idx) => {
        const rank = idx + 1;
        const isPos = item.changePct >= 0;
        const pct = (isPos ? '+' : '') + item.changePct.toFixed(2) + '%';
        const barW = Math.min(100, Math.round((Math.abs(item.changePct) / maxAbs) * 100));
        const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
        const pill = item.pillStyle
            ? '<span class="cat-pill" style="background:' + escapeHtml(item.pillStyle) + '">' + escapeHtml(item.catLabel) + '</span>'
            : '<span class="cat-pill ' + escapeHtml(item.pillClass) + '">' + escapeHtml(item.catLabel) + '</span>';

        const tvSym = toTvSymbol(item.symbol);
        return '<tr>' +
            '<td class="td-rank ' + rankClass + '">' + rank + '</td>' +
            '<td class="td-name"><div class="chart-links">' +
                '<a class="asset-link" href="https://finance.yahoo.com/chart/' + encodeURIComponent(item.symbol) + '" target="_blank" rel="noopener noreferrer" title="Yahoo Finance">' + escapeHtml(item.name) + '<span class="link-arrow">&#x2197;</span></a>' +
                '<a class="tv-link" href="https://www.tradingview.com/chart/?symbol=' + encodeURIComponent(tvSym) + '" target="_blank" rel="noopener noreferrer" title="Apri su TradingView">TV</a>' +
            '</div></td>' +
            '<td class="td-symbol">' + escapeHtml(item.symbol) + '</td>' +
            '<td class="td-change ' + (isPos ? 'pos' : 'neg') + '">' +
                pct +
                '<div class="chg-bar-wrap"><div class="chg-bar ' + (isPos ? 'bar-pos' : 'bar-neg') + '" style="width:' + barW + '%"></div></div>' +
            '</td>' +
            '<td class="td-price th-price">' + formatPrice(item.currentPrice, item.currency) + '</td>' +
            '<td class="th-cat">' + pill + '</td>' +
            '</tr>';
    }).join('');

    document.getElementById('resultsArea').innerHTML =
        '<table class="rank-table">' +
        '<thead><tr>' +
        '<th>#</th><th>Nome</th><th>Simbolo</th><th>Variazione</th>' +
        '<th class="th-price">Prezzo</th><th class="th-cat">Categoria</th>' +
        '</tr></thead>' +
        '<tbody>' + rows + '</tbody></table>';
}

// =====================================================================
// SHARE LINK
// =====================================================================
function _encodeShare(obj) {
    const bytes = new TextEncoder().encode(JSON.stringify(obj));
    return btoa(Array.from(bytes, b => String.fromCharCode(b)).join(''));
}
function _decodeShare(str) {
    const bytes = Uint8Array.from(atob(str), c => c.charCodeAt(0));
    return JSON.parse(new TextDecoder().decode(bytes));
}
function showShareToast(msg) {
    let t = document.getElementById('_shareToast');
    if (!t) {
        t = document.createElement('div'); t.id = '_shareToast';
        t.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#2ecc71;color:#fff;padding:10px 22px;border-radius:8px;font-size:0.85rem;font-weight:600;z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,0.3);transition:opacity 0.4s;white-space:nowrap;pointer-events:none;';
        document.body.appendChild(t);
    }
    t.textContent = msg; t.style.opacity = '1';
    clearTimeout(t._tmr); t._tmr = setTimeout(() => { t.style.opacity = '0'; }, 3500);
}
function exportShareLink() {
    const share = { v: 1 };
    try { const p = JSON.parse(localStorage.getItem('dashboardBorsaPresets') || 'null'); if (p && Object.keys(p).length) share.presets = p; } catch(e) {}
    try { const c = JSON.parse(localStorage.getItem('rankingCustomCats') || 'null'); if (c && Object.keys(c).length) share.cats = c; } catch(e) {}
    if (!share.presets && !share.cats) { alert('Nessuna categoria o preset personalizzato da condividere.'); return; }
    const url = location.origin + location.pathname + '?share=' + _encodeShare(share);
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url)
            .then(() => showShareToast('✓ Link copiato — aprilo sull\'altro dispositivo'))
            .catch(() => prompt('Copia questo link:', url));
    } else { prompt('Copia questo link:', url); }
}
function checkShareImport() {
    const encoded = new URLSearchParams(location.search).get('share');
    if (!encoded) return;
    history.replaceState(null, '', location.pathname);
    try {
        const share = _decodeShare(encoded);
        let n = 0;
        if (share.presets && typeof share.presets === 'object') {
            try { const ex = JSON.parse(localStorage.getItem('dashboardBorsaPresets') || '{}'); localStorage.setItem('dashboardBorsaPresets', JSON.stringify({ ...ex, ...share.presets })); n += Object.keys(share.presets).length; } catch(e) {}
        }
        if (share.cats && typeof share.cats === 'object') {
            try { const ex = JSON.parse(localStorage.getItem('rankingCustomCats') || '{}'); localStorage.setItem('rankingCustomCats', JSON.stringify({ ...ex, ...share.cats })); n += Object.keys(share.cats).length; } catch(e) {}
        }
        if (n > 0) setTimeout(() => showShareToast('✓ ' + n + (n === 1 ? ' elemento importato' : ' elementi importati') + '!'), 800);
    } catch(e) { console.warn('Share link non valido'); }
}

// ==================== INIT ====================
loadTheme();
checkShareImport();
loadCustomCats();
buildAllAssets();
renderCustomCatButtons();
</script>
</body>
</html>
